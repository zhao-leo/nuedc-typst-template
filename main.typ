#import "package/lib.typ": NUEDC-report
#import "package/components/scripts.typ": *

#show: doc => NUEDC-report(
  year: "2025",
  problem-id: "E",
  problem-name: "简易自行瞄准装置",
  team-id: "B25586",
  school: "北京邮电大学大学",
  team-members: ("XXX", "XXX","XXX"),
  teachers: ("XXX",),
  abstract: [本系统采用树莓派5作为主控制器，搭配15cm×15cm的小车底盘，实现了高机动性的自动寻迹功能。瞄准模块采用步进电机驱动的二维云台，控制405nm蓝紫激光笔精确瞄准目标靶心。系统通过树莓派的强大处理能力实现了实时图像处理和精确控制，相比传统方案具有更高的定位精度和响应速度。巡迹功能采用MSPM0G3507微控制器独立控制，确保行驶稳定性。系统电源分为两部分独立供电，分别用于控制板和瞄准模块。经测试，系统能够在规定时间内完成自动寻迹和精确瞄准任务。],
  keywords: ("树莓派", "步进云台", "自动循迹", "瞄准装置"),
  show-teachers: true,       // 是否展示指导教师
  show-cover: true,          // 是否展示封面
  show-information: false,   // 是否展示信息表格
  // 上述三个参数默认为true
  doc,
)
= 引言
由题目可知本次竞赛的目标是设计一个能够自动寻迹并精确瞄准目标的装置。为此，我们需要综合考虑小车的机动性、瞄准模块的精度以及系统的实时处理能力。
= 系统方案

本设计中的循迹小车以Ti公司的MSPM0G3507为核心控制器，使用灰度传感器阵列来检测地面上的黑线。

本设计中的视觉追踪识别模块使用树莓派5作为核心处理器，使用二维步进云台，配合摄像头模块来实现瞄准功能。

== 主控制器模块的论证与选择

=== 方案一：K210专用视觉处理模块
K210作为专用的边缘计算视觉处理模块，在功耗和专用算法处理方面具有一定优势。在实际测试中，我们发现K210对于固定模式的帧率过低。特别是在光线条件变化较大的环境下，K210的图像处理延迟会明显增加，导致整个系统的响应速度下降。另一个重要局限是其内存容量有限，难以支持复杂的多任务调度，这会影响系统在行驶过程中同时完成瞄准任务的实时性。

=== 方案二：树莓派5开发板
树莓派4B采用四核Cortex架构处理器，配合8GB内存，为系统提供了充足的计算资源。在实际应用中，我们充分利用其多核特性，将图像处理、运动控制和状态监控等任务分配到不同核心处理，实现了真正的并行计算。测试表明，即使在最复杂的工作模式下（同时进行轨迹跟踪、靶标识别和云台控制），系统仍能保持30fps以上的处理速度。树莓派丰富的接口资源也为我们提供了更多扩展可能性，比如通过GPIO实现精确的步进电机控制等。虽然功耗相对较高，但通过动态频率调整和任务调度优化，我们成功将平均功耗控制在可接受范围内。更重要的是，树莓派成熟的生态系统和丰富的开发资源大大缩短了开发周期，这对于竞赛这样的限时项目尤为重要。

== 云台驱动模块的论证与选择

=== 方案一：舵机驱动云台方案
舵机作为传统的角度控制执行器，具有控制简单、成本低廉的优势。我们测试了多款舵机，发现其在静态定位时确实能够达到不错的精度。但在实际动态瞄准过程中暴露出几个关键问题：首先是响应速度有限，普通舵机的转动速度约为60°/0.2s，这意味着从一侧极限位置转到另一侧需要较长时间，难以满足题目要求的2s内完成瞄准的要求。其次是存在明显的回差现象，当云台负载较大时，实际位置与理论位置可能产生1°-2°的偏差，这在50cm的距离上会导致约2cm的光斑偏移。更严重的是，长时间工作后舵机会出现发热导致的精度下降问题，这对需要连续工作的发挥部分任务来说是不可接受的。

=== 方案二：步进电机驱动云台
步进电机系统由步进电机、驱动器和控制电路组成。我们选用了NEMA17系列步进电机，配合具有16细分功能的驱动器，可以实现每步0.01°的理论分辨率。在实际系统中，我们采用1/16微步模式，平衡了精度和扭矩需求。测试数据显示，该方案在50cm距离上的重复定位精度可达±1mm，远超题目要求。步进电机的另一个优势是开环控制下的高可靠性，不会出现舵机那样的累积误差问题。云台能够在1.5s内完成最大范围的移动，完全满足时间要求。此外，步进电机在持续工作时的温升明显低于舵机，更适合本次竞赛的应用场景。

= 理论分析与计算

== A4靶纸的矩形识别

=== 图像预处理与特征提取
如 @figure-1，采用多级图像处理流程实现靶纸的可靠识别。首先将彩色图像转换为灰度图，通过高斯模糊消除高频噪声。使用自适应阈值分割算法提取靶纸边缘特征，该算法能自动适应不同光照条件。形态学开运算消除细小噪声干扰，保留完整的靶纸轮廓特征。
#figure(
  grid(
    columns: 2,
    gutter: 20pt,
    image("figures/black_white.png"), image("figures/color.png"),
    text("（a）二值化图像", size: 10pt), text("（b）标定结果", size: 10pt),
  ),
  caption: [
    树莓派识别结果
  ],
) <figure-1>
=== 几何特征分析与验证
通过轮廓检测算法获取候选区域后，采用`Douglas-Peucker`多边形近似算法提取多边形特征。设置严格的几何验证条件：

通过向量夹角计算验证直角特征：对于四边形四个顶点，计算相邻边向量的夹角$θ$需满足$|θ-90°|≤25°$。

=== 坐标系统规范化
检测到的有效矩形顶点通过拓扑排序算法进行规范化处理：
1. 计算各顶点坐标和（x+y）确定左上角基准点
2. 基于基准点计算其余顶点的极角
3. 按极角排序得到顺时针方向的顶点序列：[左上，右上，右下，左下]
建立规范化坐标系为后续靶心定位提供稳定参考。

=== 动态预测与补偿
结合卡尔曼滤波器实现运动预测：
- 状态向量：$X=[x,y,v x,v y ]^T$
- 观测方程：$Z=H X $，$H=[1,0,0,0; 0,1,0,0]$
- 状态预测：$X_k= "FX"_{k-1}$，其中$F$包含时间因子$ Delta t$
考虑系统延迟，采用速度补偿算法：
预测点 = 当前位置 + 速度×延迟时间
该方案使系统能准确命中移动中的靶心区域。

== PID运算

本方案采用改进型PID算法实现小车的精确轨迹跟踪控制。系统基于MSPM0微控制器平台，通过红外传感器阵列检测轨迹偏差，结合电机编码器反馈构建闭环控制系统。

算法核心采用位置式PID结构，离散化实现公式为

$ u(k)=K_p · e(k)+K_i · T_s · ∑e(j)+K_d · [e(k)-e(k-1)]/T_s $

其中关键参数经过实测优化确定为$K_p=1.5、K_i=0.5、K_d=0.3$，采样周期设置为$50m s$以确保实时性。针对巡迹过程中的不同工况，设计了多模态控制策略：直线行驶时采用标准PID参数保证稳定性；检测到弯道时自动切换为增强型参数组合（K_p=1.2、K_d=0.5）提升动态响应；启停阶段则采用Bang-Bang与PID的混合控制实现平滑过渡。

为克服系统非线性特性，算法集成了多项补偿措施。

包括基于实测数据的PWM死区补偿（±35）、分段线性化的速度- PWM映射关系，以及加速度前馈补偿。特别设计了抗积分饱和机制，当误差累积值超过200时自动暂停积分作用，同时限制相邻周期PWM变化量不超过150，有效避免了执行器饱和带来的控制失效。

稳定性保障方面，系统具备误差突变检测功能（$ Delta (k)>50m m$触发复位）、三级故障恢复流程（急停-回退-重定位）以及在线参数自整定能力。通过`Ziegler-Nichols`方法实现的自动调参模块，可在负载变化±20%工况下维持≤3mm的跟踪精度，实测表明该方案能使小车在20s内稳定完成1圈（4m）巡迹，最大偏移量不超过轨迹线宽的1/3。

#figure(
  image("figures/pid.png",width: 60%),
  caption: [
    PID控制图
  ],
)

== 步进电机控制

步进电机控制采用开环控制方式，结合微步驱动技术实现高精度定位。系统使用`Arduino`直接控制步进电机驱动器，采用16细分模式以实现每步$0.01°$的理论分辨率。

具体实现过程中，主控板通过GPIO口输出脉冲信号，驱动器根据脉冲数量和方向信号控制步进电机旋转角度。微步驱动技术通过细分电流控制，实现更平滑的运动和更高的定位精度，有效降低了机械振动和噪声。

整体方案具有结构简单、可靠性高、易于扩展的优点，适合本次自动瞄准装置的应用场景。

= 电路与调试设计

== 电路原理图
在小车部分主控方面，我们使用了嘉立创的MSPM0G3507天猛星开发板作为主控制器，配合红外传感器阵列实现循迹功能。
#figure(
  grid(
    columns: 3,
    gutter: 3pt,
    image("figures/broad/SCH_Schematic_1-core_2025-08-01.png"), image("figures/broad/SCH_Schematic_2-power_2025-08-01.png"),
    image("figures/broad/SCH_Schematic_3-extension_2025-08-01.png"),
    text("（a）核心板", size: 10pt), text("（b）供电", size: 10pt), text("（a）外周电路", size: 10pt),
  ),
  caption: [
    MSPM0G3507开发板原理图
  ],
)
在云台主控方面，我们使用了`Arduino+CNC_Shield`作为主控制器，配合步进电机驱动器实现云台的精确控制。

#figure(
  image("figures/broad/cnc_shield.jpeg", width: 50%),
  caption: [
    CNC Shield原理图
  ],
)

== 系统控制

系统总体需要分成两部分进行控制：循迹小车和瞄准云台。

循迹小车由MSPM0G3507主控板控制，使用红外传感器阵列检测地面黑线并驱动电机行驶。

#figure(
  image("figures/control/auto.png", width: 22%),
  caption: [
    循迹小车控制流程图
  ],
)
瞄准云台由树莓派+`Arduino`控制，通过步进电机实现精确定位。
#figure(
  image("figures/control/rasp.png", width: 44%),
  caption: [
    循迹小车控制流程图
  ],
)

= 测试结果与分析
#table(
  columns: (1fr, 1fr, 2fr),
  inset: 10pt,
  align: horizon,
  [*基本要求*], [*是否实现*], [*偏离情况*],
  [基本要求1], [是], [无偏离],
  [基本要求2], [是], [无偏离],
  [基本要求3], [是], [无偏离],
  [提高要求1], [是], [偏离±2cm],
  [提高要求2], [否], [偏离±5cm],
)
= 总结
本设计实现了一个高精度的自动寻迹和瞄准装置，采用树莓派5作为主控制器，结合步进电机驱动的云台系统，能够在复杂环境下稳定工作。通过对循迹算法和云台控制的优化，我们成功实现了在2秒内完成目标瞄准的要求。
在实际测试中，系统表现出良好的稳定性和精确度，能够在不同光照和地面条件下保持高效的寻迹和瞄准能力。
未来可以考虑进一步优化云台的机械结构，提升负载能力和响应速度。同时，增加更多传感器以实现更复杂的环境适应能力，如障碍物检测和避障功能。此外，基于现有平台的扩展性，我们还可以集成更多智能算法，如深度学习目标识别，以提升系统的智能化水平。
整体而言，本设计方案在满足竞赛要求的同时，展示了较高的技术水平和创新性。通过合理的硬件选择和软件优化，我们成功实现了一个高效、稳定的自动瞄准装置，具备良好的实用价值和推广前景。
